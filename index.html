<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LLM Agent POC — RAJNEESH</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 1.25rem; background:#f8f9fa; }
    #chat { height: 60vh; overflow:auto; background: #fff; border:1px solid #e0e0e0; padding:12px; border-radius:6px; }
    .msg.user { text-align:right; margin-bottom:8px; }
    .msg.assistant { text-align:left; margin-bottom:8px; }
    .bubble { display:inline-block; padding:8px 12px; border-radius:12px; max-width:80%; }
    .bubble.user { background:#0d6efd; color:white; }
    .bubble.assistant { background:#e9ecef; color:#212529; }
    .small-muted { font-size:0.8rem; color:#6c757d; margin-top:4px; }
    #alerts { margin-top:10px; }
    .controls { gap:8px; display:flex; align-items:center; }
    .form-text-small { font-size: .85rem; color: #6c757d; }
  </style>
</head>
<body>
  <div class="container">
    <h3>LLM Agent POC — RAJNEESH</h3>
    <div class="row mt-3">
      <div class="col-md-4">
        <div class="card mb-3">
          <div class="card-body">
            <h6>Settings</h6>
            <div class="mb-2">
              <label class="form-label">LLM Provider</label>
              <select id="provider" class="form-select">
                <option value="openai" selected>OpenAI</option>
                <option value="anthropic">Anthropic (placeholder)</option>
                <option value="gemini">Google Gemini (placeholder)</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">OpenAI API Key</label>
              <input id="openaiKey" type="password" class="form-control" placeholder="sk-..." />
              <div class="form-text form-text-small">Your key is kept only in memory in this page. Do not publish it.</div>
            </div>
            <div class="mb-2">
              <label class="form-label">SerpAPI Key (optional — search)</label>
              <input id="serpKey" type="text" class="form-control" placeholder="SerpAPI key (for web search)"/>
              <div class="form-text form-text-small">If absent, the agent will try DuckDuckGo instant answers as a fallback.</div>
            </div>
            <div class="mb-2">
              <label class="form-label">AI Pipe Endpoint (optional)</label>
              <input id="aipipeEndpoint" type="text" class="form-control" placeholder="https://my-aipipe-proxy.example/run" />
              <div class="form-text form-text-small">Optional: a proxy endpoint for AI Pipe calls (if you run one).</div>
            </div>
            <div class="mb-2">
              <label class="form-label">Model</label>
              <input id="modelName" class="form-control" placeholder="gpt-4o-mini or gpt-4-0613 (OpenAI)" value="gpt-4o-mini"/>
            </div>
            <div class="mb-2">
              <label class="form-label">Max function loop iterations</label>
              <input id="maxLoops" class="form-control" type="number" value="6" />
            </div>
            <div class="mt-2">
              <button id="clearBtn" class="btn btn-secondary btn-sm">Clear Chat</button>
              <button id="demoBtn" class="btn btn-outline-primary btn-sm">Load Demo Prompt</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h6>How to use</h6>
            <ol>
              <li>Paste your OpenAI key (or another provider — adapt code).</li>
              <li>Enter a query in the chat box and press Send.</li>
              <li>If the AI requests tools (search, aipipe, run_js) they will be executed and the loop continues automatically.</li>
            </ol>
            <div class="form-text-small">Notes: This is a POC. Running in-browser exposes the API key to the page — do not use production keys publicly.</div>
          </div>
        </div>

      </div>

      <div class="col-md-8">
        <div id="alerts"></div>

        <div id="chat" class="mb-2" aria-live="polite"></div>

        <div class="input-group mt-2">
          <input id="userInput" type="text" class="form-control" placeholder="Type your request e.g. 'Interview me to make a blog post about IBM'"/>
          <button id="sendBtn" class="btn btn-primary">Send</button>
          <button id="runCodeBtn" class="btn btn-outline-success" title="Quick run code">Run JS</button>
        </div>
        <div class="form-text-small mt-1">You can ask the agent to search the web, call AI Pipe (if configured), or ask it to run JavaScript.</div>

      </div>
    </div>
  </div>

<script>
/*
  LLM Agent POC (browser)
  - Uses OpenAI Chat Completions with function-calling to request tool usage.
  - Tools implemented: search, aipipe, run_js.
  - The user supplies API keys in the UI (not stored).
  - Note: For production, never put secrets in client-side code.
*/

const chatEl = document.getElementById('chat');
const alertsEl = document.getElementById('alerts');
const sendBtn = document.getElementById('sendBtn');
const userInput = document.getElementById('userInput');
const providerEl = document.getElementById('provider');
const openaiKeyEl = document.getElementById('openaiKey');
const serpKeyEl = document.getElementById('serpKey');
const aipipeEndpointEl = document.getElementById('aipipeEndpoint');
const modelNameEl = document.getElementById('modelName');
const clearBtn = document.getElementById('clearBtn');
const demoBtn = document.getElementById('demoBtn');
const runCodeBtn = document.getElementById('runCodeBtn');
const maxLoopsEl = document.getElementById('maxLoops');

let messages = []; // OpenAI-style messages
let busy = false;

function showAlert(msg, type='danger', timeout=8000) {
  const id = 'a'+Math.random().toString(36).slice(2,9);
  const el = document.createElement('div');
  el.id = id;
  el.className = `alert alert-${type} alert-dismissible`;
  el.role = 'alert';
  el.innerHTML = `<div>${escapeHtml(msg)}</div><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
  alertsEl.appendChild(el);
  if (timeout) setTimeout(()=>{ try{el.remove()}catch(e){} }, timeout);
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function appendMessage(role, text, meta='') {
  const wrap = document.createElement('div');
  wrap.className = 'msg '+(role==='user'?'user':'assistant');
  const bubble = document.createElement('div');
  bubble.className = 'bubble '+(role==='user'?'user':'assistant');
  bubble.innerHTML = text.split('\n').map(escapeHtml).join('<br/>');
  wrap.appendChild(bubble);
  if (meta) {
    const m = document.createElement('div');
    m.className = 'small-muted';
    m.textContent = meta;
    wrap.appendChild(m);
  }
  chatEl.appendChild(wrap);
  chatEl.scrollTop = chatEl.scrollHeight;
}

clearBtn.onclick = ()=>{ messages=[]; chatEl.innerHTML=''; alertsEl.innerHTML=''; showAlert('Chat cleared','info',3000); }
demoBtn.onclick = ()=>{ userInput.value = 'Interview me to create a blog post about IBM'; }

runCodeBtn.onclick = ()=> {
  const code = prompt('Enter JS code to run (the agent can also request run_js):', "return 'hello from code';");
  if (code) {
    // run in sandbox and show output
    runJsInSandbox(code).then(res=>{
      appendMessage('assistant', 'JS result:\n'+JSON.stringify(res, null, 2), 'run_js result');
    }).catch(e=>{
      showAlert('run_js error: '+e);
    });
  }
}

sendBtn.onclick = ()=> { const t = userInput.value.trim(); if(!t) return; userInput.value=''; handleUserInput(t); }

userInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendBtn.click(); } });

/* ================= LLM / agent loop ================= */

const FUNCTIONS = [
  {
    name: "search",
    description: "Search the web and return short snippets. Arguments: {query:string}",
    parameters: {
      type: "object",
      properties: {
        query: { type: "string", description: "Search query" }
      },
      required: ["query"]
    }
  },
  {
    name: "aipipe",
    description: "Call an AI Pipe proxy endpoint. Arguments: {endpoint:string,input:string}",
    parameters: {
      type: "object",
      properties: {
        endpoint: { type: "string" },
        input: { type: "string" }
      },
      required: ["endpoint","input"]
    }
  },
  {
    name: "run_js",
    description: "Execute JavaScript code in a sandbox and return result. Arguments: {code:string}",
    parameters: {
      type: "object",
      properties: {
        code: { type: "string" }
      },
      required: ["code"]
    }
  }
];

async function callOpenAI(messages) {
  const key = openaiKeyEl.value.trim();
  if(!key) throw new Error('OpenAI key required in Settings.');
  const model = modelNameEl.value.trim() || 'gpt-4o-mini';
  const url = 'https://api.openai.com/v1/chat/completions';
  const body = {
    model,
    messages,
    functions: FUNCTIONS,
    temperature: 0.2,
    max_tokens: 800
  };
  const res = await fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer '+key,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const text = await res.text();
    throw new Error('OpenAI error: '+res.status+' '+text);
  }
  const data = await res.json();
  return data;
}

async function executeToolCall(call) {
  const name = call.name;
  let args = {};
  try { args = JSON.parse(call.arguments || '{}'); } catch(e){ args = {raw: call.arguments}; }
  if(name === 'search'){
    return runSearch(args.query);
  } else if(name === 'aipipe'){
    return runAipipe(args.endpoint, args.input);
  } else if(name === 'run_js'){
    return runJsInSandbox(args.code);
  } else {
    return `Unknown tool: ${name}`;
  }
}

async function runSearch(query) {
  if(!query) return 'No query provided';
  const serpKey = serpKeyEl.value.trim();
  try {
    if(serpKey){
      const url = 'https://serpapi.com/search.json?q=' + encodeURIComponent(query) + '&api_key=' + encodeURIComponent(serpKey);
      const r = await fetch(url);
      if(!r.ok) {
        const t = await r.text();
        return `SerpAPI error ${r.status}: ${t}`;
      }
      const j = await r.json();
      const items = (j.organic_results || j.org_results || []).slice(0,4).map(it=>({title: it.title||it.position||'', snippet: it.snippet || it.snippet || it.description || it.snippet_text || '' , link: it.link || it.url || ''}));
      return JSON.stringify({provider:'serpapi', query, results: items}, null, 2);
    } else {
      // DuckDuckGo Instant Answer fallback
      const url = 'https://api.duckduckgo.com/?q=' + encodeURIComponent(query) + '&format=json&no_redirect=1&no_html=1';
      const r = await fetch(url);
      if(!r.ok) {
        const t = await r.text();
        return `DuckDuckGo error ${r.status}: ${t}`;
      }
      const j = await r.json();
      const results = [];
      if(j.AbstractText) results.push({title:'InstantAnswer', snippet: j.AbstractText});
      if(Array.isArray(j.RelatedTopics)) {
        j.RelatedTopics.slice(0,4).forEach(rt=>{
          if(rt.Text) results.push({title: rt.Text.split(' - ')[0], snippet: rt.Text, link: rt.FirstURL||''});
        })
      }
      return JSON.stringify({provider:'duckduckgo', query, results}, null, 2);
    }
  } catch(e) {
    return `search error: ${String(e)}`;
  }
}

async function runAipipe(endpoint, input) {
  if(!endpoint) return 'No aipipe endpoint provided in tool args or settings.';
  try {
    const r = await fetch(endpoint, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({input})
    });
    if(!r.ok) {
      const t = await r.text();
      return `aipipe error ${r.status}: ${t}`;
    }
    const j = await r.json().catch(()=>null);
    if(j) return JSON.stringify(j, null, 2);
    const txt = await r.text();
    return txt;
  } catch(e){
    return `aipipe exception: ${String(e)}`;
  }
}

/* Run JS in a sandboxed iframe (srcdoc). Returns an object with {result, logs} or throws */
function runJsInSandbox(code, timeoutMs=5000){
  return new Promise((resolve, reject)=>{
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    const srcdoc = `
      <!doctype html><html><body>
      <script>
      const logs = [];
      console.log = function(){ logs.push(Array.from(arguments).map(a=>{ try{return JSON.stringify(a)}catch(e){return String(a)} }).join(' ')); };
      (async function(){
        try{
          const code = "";
          let val = (async function(){ return eval(code); })();
          val = await val;
          parent.postMessage({type:'run_js_result', result: val, logs}, '*');
        } catch(e) {
          parent.postMessage({type:'run_js_result', error: String(e), logs}, '*');
        }
      })();
      <\/script>
      </body></html>
    `;
    iframe.srcdoc = srcdoc.replace('""', JSON.stringify(code));
    document.body.appendChild(iframe);

    function handler(ev){
      if(ev.source !== iframe.contentWindow) return;
      const d = ev.data || {};
      if(d && d.type === 'run_js_result'){
        window.removeEventListener('message', handler);
        try{ iframe.remove(); } catch(e){}
        if(d.error) reject(d.error);
        else resolve({result: d.result, logs: d.logs});
      }
    }
    window.addEventListener('message', handler);

    const to = setTimeout(()=> {
      window.removeEventListener('message', handler);
      try{ iframe.remove(); }catch(e){}
      reject('run_js timeout');
    }, timeoutMs);
    const origResolve = resolve;
    resolve = function(v){ clearTimeout(to); origResolve(v); };
    const origReject = reject;
    reject = function(e){ clearTimeout(to); origReject(e); };
  });
}

/* Main handler: send user input, then run LLM loop that executes tools */
async function handleUserInput(text){
  if(busy) return showAlert('Agent busy, wait for completion.', 'warning', 3000);
  busy = true;
  appendMessage('user', text);
  messages.push({role:'user', content:text});
  try {
    let loopCount = 0;
    while(loopCount < parseInt(maxLoopsEl.value||6,10)){
      loopCount++;
      appendMessage('assistant', 'Thinking...', '…');
      // call LLM
      const data = await callOpenAI(messages);
      const choice = data.choices && data.choices[0];
      if(!choice) throw new Error('No choices from LLM');
      const msg = choice.message;
      if(msg.function_call){
        const fc = msg.function_call;
        appendMessage('assistant', `Requested tool: ${fc.name}(${fc.arguments || ''})`, 'tool_call');
        const toolResult = await executeToolCall(fc);
        messages.push({role:'function', name: fc.name, content: typeof toolResult === 'string' ? toolResult : JSON.stringify(toolResult)});
        appendMessage('assistant', `Tool ${fc.name} result received.`, 'tool_result');
        continue;
      } else {
        const content = msg.content || (msg.message && msg.message.content) || '';
        appendMessage('assistant', content);
        messages.push({role:'assistant', content});
        break;
      }
    }
    if(loopCount >= parseInt(maxLoopsEl.value||6,10)){
      appendMessage('assistant', 'Max function loop iterations reached.', 'warning');
      showAlert('Max loops reached. If the agent still wants to call tools, increase the "Max function loop iterations" setting.', 'warning', 8000);
    }
  } catch(e){
    console.error(e);
    showAlert(String(e), 'danger', 10000);
  } finally {
    busy = false;
  }
}

/* Initial demo content */
appendMessage('assistant', 'Agent ready. Type a request and press Send. Try: "Search IBM and summarize its founding and mission."');

</script>
</body>
</html>
